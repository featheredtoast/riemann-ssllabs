#!/usr/bin/env ruby

# Send ssllab grade to riemann

require 'riemann/tools'

class Riemann::Tools::Ssllabs
  include Riemann::Tools
  
  require 'ssllabs'
  require 'json'

  opt :ssllab_host, "ssllab host", :default => 'google.com'
  
  def initialize
    options[:interval] = 3600
    options[:ttl] = 7200
  end

  def tick
    api = ::Ssllabs::Api.new
    r = api.analyse(host: opts[:ssllab_host], publish: 'off', startNew: 'on')
    puts JSON.generate(r)

    while r.status != "READY" and r.status != "ERROR" do
      sleep(5)
      r = api.analyse(host: opts[:ssllab_host], publish: 'off')
      puts JSON.generate(r)
    end

    grade = r.endpoints[0].grade
    puts "grade: " + grade
    
    data = {
      :host    => opts[:ssllab_host],
      :service => "ssllab-grade",
      :state   => grade,
      :tags    => ['ssllab']
    }

    data[:metric] = 
      case data[:state]
      when /^[DF]/
        2
      when /^C/
        1
      else 0
      end

    report(data)
  end
end

Riemann::Tools::Ssllabs.run
